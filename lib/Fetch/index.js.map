{"version":3,"sources":["../../src/Fetch/index.jsx"],"names":["React","Component","_","requesting","Fetch","props","getCache","key","getActuallyCacheKey","value","window","sessionStorage","getItem","JSON","parse","setCache","setItem","stringify","cacheKey","last","history","params","requestSuccCallback","res","requestParams","response","onResponse","setState","loading","onLoadingChange","requestErrCallback","request","Date","getTime","Object","assign","onRequest","api","then","forEach","item","success","catch","error","push","getData","isArray","length","state","nextProps","isEqual","console","log","setTimeout","component","cloneElement","defaultProps","data"],"mappings":"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","file":"index.js","sourcesContent":["/**\r\n * 数据获取组件\r\n */\r\nimport React, { Component } from 'react';\r\nimport _ from 'lodash';\r\n\r\nlet requesting = {};\r\n\r\nexport default class Fetch extends Component {\r\n  constructor(props) {\r\n    super(props);\r\n    this.state = {\r\n      loading: false,\r\n      response: {}\r\n    };\r\n  }\r\n\r\n  static defaultProps = {\r\n    api: null,\r\n    history: [],\r\n    params: null,\r\n    cacheKey: null, // 定义该字段时，将在本地进行缓存，当history中最后一个对象+params+cacheKey这几个都未变更时，接口不发起\r\n    onRequest: params => params,\r\n    onResponse: res => ({ data: res }),\r\n    component: null, // 子元素组件\r\n    onLoadingChange: null, // 状态变更事件\r\n  }\r\n\r\n  componentWillReceiveProps(nextProps) {\r\n    if (!_.isEqual(this.props.history, nextProps.history)) {\r\n      console.log(nextProps.history);\r\n      setTimeout(this.getData);\r\n    }\r\n  }\r\n\r\n  componentDidMount() {\r\n    this.getData();\r\n    this.props.onLoadingChange && this.props.onLoadingChange(false);\r\n  }\r\n\r\n  componentWillUnmount() {}\r\n\r\n  getCache = () => {\r\n    let key = this.getActuallyCacheKey();\r\n    let value = window.sessionStorage.getItem(key);\r\n    if (!value) {\r\n      return null;\r\n    }\r\n    return JSON.parse(window.sessionStorage.getItem(key) || '{}');\r\n  }\r\n\r\n  setCache = (value) => {\r\n    let key = this.getActuallyCacheKey();\r\n    window.sessionStorage.setItem(this.getActuallyCacheKey(key), JSON.stringify(value));\r\n  }\r\n\r\n  /**\r\n   * 生成key\r\n   * @return {[type]} [description]\r\n   */\r\n  getActuallyCacheKey = () => {\r\n    return `${JSON.stringify(this.props.cacheKey)}-${JSON.stringify(_.last(this.props.history))}-${JSON.stringify(this.props.params)}`;\r\n  }\r\n\r\n  requestSuccCallback = (res, requestParams) => {\r\n    let response = this.props.onResponse(res, requestParams);\r\n    if (this.props.cacheKey) {\r\n      this.setCache(response);\r\n    }\r\n    this.setState({\r\n      loading: false,\r\n      response: response\r\n    });\r\n    this.props.onLoadingChange && this.props.onLoadingChange(false);\r\n  }\r\n\r\n  requestErrCallback = (res, requestParams) => {\r\n    this.setState({ loading: false });\r\n    this.props.onLoadingChange && this.props.onLoadingChange(false);\r\n  }\r\n\r\n  request = () => {\r\n    this.setState({ loading: true });\r\n    this.props.onLoadingChange && this.props.onLoadingChange(true);\r\n\r\n    // 判定队列中是否有相同请求，如果开启缓存且队列中已存在，则不在请求\r\n    let key = new Date().getTime();\r\n    if (this.props.cacheKey) {\r\n      key = this.getActuallyCacheKey();\r\n    }\r\n    if (!requesting[key]) {\r\n      requesting[key] = [];\r\n      let params = Object.assign({}, _.last(this.props.history), this.props.params);\r\n      params = this.props.onRequest(params) || params;\r\n      this.props.api(params)\r\n        .then(res => {\r\n          requesting[key].forEach(item => item.success(res, params));\r\n          delete requesting[key];\r\n        }).catch(res => {\r\n          requesting[key].forEach(item => item.error(res, params));\r\n          delete requesting[key];\r\n        });\r\n    }\r\n    requesting[key].push({ success: this.requestSuccCallback, error: this.requestErrCallback });\r\n  }\r\n\r\n  getData = () => {\r\n    if (!this.props.api || !_.isArray(this.props.history) || this.props.history.length === 0) {\r\n      return;\r\n    }\r\n    if (this.props.cacheKey) {\r\n      let response = this.getCache();\r\n      if (response) {\r\n        this.setState({ response });\r\n        return;\r\n      }\r\n    }\r\n    this.request();\r\n  }\r\n\r\n  render() {\r\n    if (!this.props.component) {\r\n      return null;\r\n    }\r\n    let props = { loading: this.state.loading, ...this.state.response };\r\n    return React.cloneElement(this.props.component, props);\r\n  }\r\n}"]}